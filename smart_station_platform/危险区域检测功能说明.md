# 🚨 危险区域检测功能说明

## 功能概述

危险区域检测是SmartEye-Station-Guard系统的高级安全功能，能够实时监控指定区域内的人员活动，及时发现入侵、停留超时等异常行为，为安全监控提供强有力的技术支撑。

## 核心特性

### 🎯 多边形区域定义
- 支持任意多边形危险区域绘制
- 精确的几何算法计算（Ray Casting算法）
- 实时Canvas交互绘制体验

### 📏 智能距离检测
- 点到多边形边缘的精确距离计算
- 可配置距离阈值告警
- 像素级精度定位

### ⏱️ 停留时间追踪
- 持续追踪人员在区域内的停留时间
- 可配置停留时间阈值
- 防止重复告警机制

### 🔄 多目标追踪集成
- 基于Deep SORT的人员追踪ID
- 持久化人员身份识别
- 自动清理过期追踪数据

## 功能架构

### 1. 前端Canvas绘制系统

#### 交互式区域绘制
```typescript
// 开始绘制模式
const startDrawingZone = () => {
  isDrawingZone.value = true
  overlayCanvas.value.style.pointerEvents = 'auto'
  overlayCanvas.value.addEventListener('click', handleCanvasClick)
}

// 实时坐标转换
const handleCanvasClick = (event) => {
  const rect = overlayCanvas.value.getBoundingClientRect()
  const canvasX = (event.clientX - rect.left / rect.width) * overlayCanvas.value.width
  const canvasY = (event.clientY - rect.top / rect.height) * overlayCanvas.value.height
  currentZonePoints.value.push([canvasX, canvasY])
}
```

#### 区域可视化渲染
- 实时预览绘制中的区域
- 半透明填充显示已完成区域
- 顶点序号标识
- 区域名称标签

### 2. AI服务几何算法

#### Ray Casting点在多边形内判断
```python
@staticmethod
def point_in_polygon(point: Point, polygon: List[Point]) -> bool:
    """使用射线投射算法判断点是否在多边形内"""
    x, y = point.x, point.y
    n = len(polygon)
    inside = False
    
    p1x, p1y = polygon[0].x, polygon[0].y
    for i in range(1, n + 1):
        p2x, p2y = polygon[i % n].x, polygon[i % n].y
        if y > min(p1y, p2y):
            if y <= max(p1y, p2y):
                if x <= max(p1x, p2x):
                    if p1y != p2y:
                        xinters = (y - p1y) * (p2x - p1x) / (p2y - p1y) + p1x
                    if p1x == p2x or x <= xinters:
                        inside = not inside
        p1x, p1y = p2x, p2y
    
    return inside
```

#### 点到多边形距离计算
```python
@staticmethod
def point_to_polygon_distance(point: Point, polygon: List[Point]) -> float:
    """计算点到多边形边缘的最短距离"""
    if GeometryUtils.point_in_polygon(point, polygon):
        return 0.0
    
    min_distance = float('inf')
    for i in range(len(polygon)):
        j = (i + 1) % len(polygon)
        distance = GeometryUtils.point_to_line_distance(point, polygon[i], polygon[j])
        min_distance = min(min_distance, distance)
    
    return min_distance
```

### 3. 人员追踪与状态管理

#### PersonTracker类
```python
@dataclass
class PersonTracker:
    tracking_id: str
    first_detected_time: float = field(default_factory=time.time)
    last_seen_time: float = field(default_factory=time.time)
    zone_entry_time: Optional[float] = None
    current_position: Optional[Point] = None
    inside_zone: bool = False
    distance_to_zone: float = float('inf')
    alert_triggered: bool = False
```

#### 智能告警策略
- **入侵告警**: 人员进入危险区域时立即触发
- **停留告警**: 在区域内停留超过设定时间后触发
- **接近告警**: 人员距离区域边缘小于阈值时触发
- **冷却机制**: 防止同一事件重复告警

## 使用指南

### 步骤1: 启动系统
```bash
# 启动AI服务
cd smart_station_platform/ai_service
python app.py

# 启动前端
cd smart_station_platform/frontend
npm run dev

# 启动后端（如需存储告警）
cd smart_station_platform/backend
python manage.py runserver
```

### 步骤2: 开始监控
1. 打开AI视频监控页面
2. 选择摄像头并启动视频流
3. 确保目标检测和人脸识别已启用

### 步骤3: 绘制危险区域
1. 点击"绘制区域"按钮
2. 在视频画面上点击绘制多边形顶点
3. 右键完成区域绘制
4. 设置区域参数：
   - **区域名称**: 便于识别的名称
   - **距离阈值**: 触发接近告警的距离(像素)
   - **停留阈值**: 触发停留告警的时间(秒)

### 步骤4: 管理区域
- **查看区域**: 点击"区域管理"查看所有配置
- **删除区域**: 在管理界面删除不需要的区域
- **同步配置**: 点击"同步到AI服务"保存配置

### 步骤5: 监控告警
- 实时告警面板显示危险区域事件
- 检测结果中包含区域入侵信息
- 后端存储详细告警记录

## API接口

### 配置危险区域
```http
POST /danger_zone/config/
Content-Type: application/json

{
  "camera_id": "webcam_monitor",
  "zones": [
    {
      "name": "设备操作区",
      "coordinates": [[100, 100], [300, 100], [300, 300], [100, 300]],
      "min_distance_threshold": 50.0,
      "time_in_area_threshold": 10,
      "is_active": true
    }
  ]
}
```

### 获取区域状态
```http
GET /danger_zone/status/{camera_id}
```

### 删除区域
```http
DELETE /danger_zone/{camera_id}/{zone_id}
```

## 告警类型

### 1. 区域入侵 (danger_zone_entry)
```json
{
  "type": "danger_zone_entry",
  "message": "人员 FB_1 进入危险区域 设备操作区",
  "tracking_id": "FB_1",
  "zone_name": "设备操作区",
  "position": [250, 200]
}
```

### 2. 停留超时 (danger_zone_dwell)
```json
{
  "type": "danger_zone_dwell", 
  "message": "人员 FB_1 在危险区域 设备操作区 停留超过 10 秒",
  "tracking_id": "FB_1",
  "dwell_time": 15.3,
  "zone_name": "设备操作区"
}
```

### 3. 接近告警 (danger_zone_proximity)
```json
{
  "type": "danger_zone_proximity",
  "message": "人员 FB_2 接近危险区域 设备操作区 (距离: 35.2像素)",
  "tracking_id": "FB_2", 
  "distance": 35.2,
  "zone_name": "设备操作区"
}
```

## 性能优化

### 1. 几何算法优化
- 使用稀疏采样进行快速预判
- 边界框预筛选减少计算量
- 缓存多边形边界框信息

### 2. 追踪器管理
- 自动清理30秒未见的追踪器
- 最小化内存占用
- 高效的哈希表查找

### 3. 告警去重
- 5秒冷却时间防止重复告警
- 状态变化驱动的事件模型
- 异步后端通信避免阻塞

## 应用场景

### 🏭 工业安全
- 禁止进入的危险设备区域
- 高压电区域人员监控
- 化学品存储区域管制

### 🏢 办公安全  
- 服务器机房访问控制
- 重要文件存储区监控
- 安全出入口管理

### 🏠 家庭安全
- 儿童活动区域监控
- 厨房危险区域提醒
- 楼梯口安全监护

### 🏥 医疗环境
- 手术室无菌区域
- 危险药品存储区
- 重症监护区域管理

## 技术规格

- **检测精度**: 像素级精确定位
- **响应延迟**: < 100ms实时检测
- **区域数量**: 每摄像头支持10+个区域
- **并发追踪**: 支持20+人员同时追踪
- **几何算法**: O(n)复杂度射线投射
- **兼容性**: 支持任意多边形形状

## 故障排除

### 问题1: 区域绘制不响应
- 确保摄像头已启动
- 检查Canvas元素是否正确初始化
- 验证事件监听器绑定状态

### 问题2: 检测结果不准确
- 检查坐标系转换是否正确
- 验证视频分辨率与Canvas尺寸匹配
- 确认目标检测功能正常工作

### 问题3: 告警重复触发
- 检查冷却时间设置
- 验证追踪ID稳定性
- 调整距离和时间阈值

### 问题4: 性能影响
- 减少危险区域数量
- 降低检测频率
- 启用性能优化模式

---

**开发团队**: SmartEye-Station-Guard
**版本**: v1.0.0
**更新日期**: 2024年12月 